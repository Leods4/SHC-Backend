Documenta√ß√£o da API - Sistema de Horas Complementares (SHC)

1. Vis√£o Geral

API RESTful desenvolvida para ser o backend de um sistema de gerenciamento de atividades complementares. A API oferece uma interface robusta para ser consumida por uma aplica√ß√£o frontend (ex: React, Vue, Angular), gerenciando usu√°rios, cursos, e o ciclo de vida de certificados.

Framework: Laravel 12

Banco de Dados: PostgreSQL

Autentica√ß√£o: Laravel Sanctum (API Tokens)

Plataforma de Deploy (Sugerida): Render

2. Configura√ß√£o e Execu√ß√£o Local

Pr√©-requisitos: PHP 8.2+, Composer, PostgreSQL.

Clonar o reposit√≥rio:

git clone [https://github.com/Leods4/SHC-Backend.git](https://github.com/Leods4/SHC-Backend.git)
cd SHC-Backend


Instalar depend√™ncias:

composer install


Configurar o ambiente:

Copie o arquivo de exemplo: cp .env.example .env

Abra o arquivo .env e configure as vari√°veis do banco de dados (DB_HOST, DB_PORT, DB_DATABASE, DB_USERNAME, DB_PASSWORD).

Gerar a chave da aplica√ß√£o:

php artisan key:generate


Executar as migra√ß√µes do banco de dados:

php artisan migrate


Criar o link de armazenamento (ESSENCIAL para uploads):
Este comando torna os arquivos enviados (certificados) acess√≠veis publicamente.

php artisan storage:link


Iniciar o servidor local:

php artisan serve


A API estar√° dispon√≠vel em http://localhost:8000.

3. Funcionalidades e Detalhes de Implementa√ß√£o

Esta se√ß√£o detalha as principais funcionalidades e como as regras de neg√≥cio foram implementadas.

3.1 üîê Autentica√ß√£o e Autoriza√ß√£o

Autentica√ß√£o (AuthController): Implementa registro, login, logout e renova√ß√£o de tokens (refreshToken) utilizando Laravel Sanctum. As rotas s√£o protegidas pelo middleware auth:sanctum.

Autoriza√ß√£o (Policies): A especifica√ß√£o pedia para "restringir o acesso... utilizando Policies". A implementa√ß√£o real definiu as seguintes regras de neg√≥cio em classes Policy dedicadas:

UsuarioPolicy.php: Define que um usu√°rio pode editar a si mesmo, mas apenas um ADMINISTRADOR pode deletar outros usu√°rios. SECRETARIA e COORDENADOR possuem permiss√µes de visualiza√ß√£o ampliadas.

CursoPolicy.php: Apenas ADMINISTRADOR e SECRETARIA podem criar ou deletar cursos, enquanto COORDENADOR pode atualiz√°-los.

CertificadoPolicy.php: Cont√©m a l√≥gica mais complexa. Apenas ALUNOS podem criar certificados, e s√≥ podem edit√°-los se o status for ENTREGUE. A avalia√ß√£o √© restrita a COORDENADOR, SECRETARIA e ADMINISTRADOR.

3.2 üì¶ Gest√£o de Certificados e Uploads

Uploads (CertificadoController): A rota POST /api/certificados processa requisi√ß√µes multipart/form-data para o upload de arquivos. O arquivo √© armazenado em storage/app/public/certificados e o caminho √© salvo no banco de dados.

Valida√ß√£o (StoreCertificadoRequest): A especifica√ß√£o pedia "Valida√ß√£o... via classes FormRequest". A implementa√ß√£o garante que o arquivo seja do tipo PDF e tenha um tamanho m√°ximo de 5MB. Tamb√©m impede que certificados sejam submetidos com data futura.

3.3 üßæ Hist√≥rico Autom√°tico de Altera√ß√µes

Rastreamento (Observers): A especifica√ß√£o pedia para "utilizar Model Observers". Foram criados UsuarioObserver e CertificadoObserver para "escutar" eventos do Eloquent (created, updated, deleted).

Como Funciona: No evento updated, o observer utiliza getChanges() para registrar apenas os campos que foram alterados. No evento created, o estado completo do novo registro √© salvo. Em todos os casos, Auth::id() √© usado para registrar quem realizou a a√ß√£o, criando um log de auditoria completo e autom√°tico.

3.4 üßÆ C√°lculo de Horas e Filtros

C√°lculo de Progresso (UsuarioController@showProgresso): Endpoint dedicado que soma as horas_validadas de todos os certificados APROVADOS de um aluno e retorna o total, junto com as horas necess√°rias do curso.

Filtros e Buscas (index methods): Os m√©todos index dos controladores (ex: CertificadoController) suportam filtros via query parameters, como ?status=APROVADO, permitindo buscas din√¢micas na API.

3.5 üèóÔ∏è Arquitetura e Componentes de Liga√ß√£o

Enums (app/Enums): Foram utilizados PHP Enums para garantir a consist√™ncia e integridade dos dados para pap√©is de usu√°rio, status e categorias de certificados. Eles servem como a "fonte da verdade", evitando o uso de strings m√°gicas no c√≥digo.

Provedores de Servi√ßo (app/Providers):

AuthServiceProvider.php: Este arquivo √© respons√°vel por "registrar" as Policies. √â aqui que mapeamos um Modelo (Usuario::class) √† sua respectiva Policy (UsuarioPolicy::class), informando ao Laravel como autorizar a√ß√µes.

AppServiceProvider.php: Este provedor registra os Observers. Ao vincular Usuario::class a UsuarioObserver::class, garantimos que o observer seja acionado automaticamente sempre que um usu√°rio for criado, atualizado ou deletado.

Configura√ß√£o de CORS e Sanctum:

Para permitir a comunica√ß√£o com o frontend, o arquivo config/cors.php foi ajustado para permitir a origem do cliente e suportar credenciais (supports_credentials = true).

Adicionalmente, a vari√°vel SANCTUM_STATEFUL_DOMAINS no arquivo .env foi configurada para informar ao Sanctum quais dom√≠nios frontend podem fazer requisi√ß√µes autenticadas.

4. Refer√™ncia da API (Endpoints)

4.1 Rotas P√∫blicas

POST /api/auth/register

Registra um novo usu√°rio.

POST /api/auth/login

Autentica um usu√°rio e retorna um token.

4.2 Autentica√ß√£o (Rotas Protegidas)

POST /api/auth/logout

Faz logout do usu√°rio (revoga o token).

POST /api/auth/refresh

Gera um novo token de acesso.

4.3 Usu√°rios (Rotas Protegidas)

GET /api/usuarios

Lista todos os usu√°rios.

POST /api/usuarios

Cria um novo usu√°rio.

GET /api/usuarios/{id}

Exibe um usu√°rio espec√≠fico.

PUT /api/usuarios/{id}

Atualiza um usu√°rio.

DELETE /api/usuarios/{id}

Deleta um usu√°rio.

GET /api/usuarios/{id}/progresso

Mostra o progresso de horas do usu√°rio.

GET /api/usuarios/{id}/historico

Mostra o hist√≥rico de altera√ß√µes do usu√°rio.

4.4 Cursos (Rotas Protegidas)

GET /api/cursos

Lista todos os cursos.

POST /api/cursos

Cria um novo curso.

GET /api/cursos/{id}

Exibe um curso espec√≠fico.

PUT /api/cursos/{id}

Atualiza um curso.

DELETE /api/cursos/{id}

Deleta um curso.

4.5 Certificados (Rotas Protegidas)

GET /api/certificados

Lista certificados (Aluno s√≥ v√™ os seus).

POST /api/certificados

Submete um novo certificado (com upload).

GET /api/certificados/{id}

Exibe um certificado espec√≠fico.

PUT /api/certificados/{id}

Atualiza um certificado (se ainda n√£o avaliado).

DELETE /api/certificados/{id}

Deleta um certificado (se ainda n√£o avaliado).

PATCH /api/certificados/{id}/avaliar

Avalia (aprova/reprova) um certificado.

GET /api/certificados/{id}/historico

Mostra o hist√≥rico de altera√ß√µes do certificado.

5. Estrutura da Aplica√ß√£o

5.1 Estrutura de Dados

Enumera√ß√µes (Tipos pr√©-definidos)

TipoUsuario (Enum):

ALUNO

COORDENADOR

SECRETARIA

ADMINISTRADOR

StatusCertificado (Enum):

ENTREGUE

APROVADO

REPROVADO

APROVADO_COM_RESSALVAS

CategoriaCertificado (Enum):

CIENTIFICO_ACADEMICA

SOCIOCULTURAL

PRATICA_PROFISSIONAL

Modelos (Entidades Principais)

Usuario

Atributos: id, nome, email, senha (hash), matricula, data_nascimento, tipo, dados_adicionais (JSON), curso_id, fase.

Relacionamentos: curso(), certificados(), cursosCoordenados(), historicoResponsavel().

Curso

Atributos: id, nome, horasNecessarias.

Relacionamentos: alunos(), coordenadores().

Certificado

Atributos: id, usuario_id, categoria, status, carga_horaria_solicitada, horas_validadas, nome_certificado, instituicao, data_emissao, observacao, arquivo.

Relacionamentos: requerente(), historico().

HistoricoAlteracao

Atributos: id, responsavel_id, historicoable_type, historicoable_id, alteracao (JSON), observacao, data_alteracao.

Relacionamentos: responsavel(), historicoable() (polim√≥rfico).

5.2 Componentes e L√≥gica

Controllers

AuthController: register(), login(), logout(), refreshToken()

UsuarioController: index(), store(), show(), update(), destroy(), showProgresso()

CursoController: index(), store(), show(), update(), destroy()

CertificadoController: index(), store(), show(), update(), destroy(), avaliar()

UsuarioHistoricoController: index()

CertificadoHistoricoController: index()

Observers (Gatilhos de Eventos)

UsuarioObserver: created(), updated()

CertificadoObserver: created(), updated()
